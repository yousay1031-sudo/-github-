<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理画面 | TOKACHI YAKINIKU KARIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600;700&family=Noto+Sans+JP:wght@300;400;500&display=swap');
      
      body {
        font-family: 'Noto Sans JP', sans-serif;
      }
      
      h1, h2, h3, h4 {
        font-family: 'Noto Serif JP', serif;
      }
      
      .bg-luxury {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      }
      
      .modal {
        display: none;
      }
      
      .modal.active {
        display: flex;
      }
    </style>
</head>
<body class="bg-gray-100">
    <!-- ナビゲーション -->
    <nav class="bg-luxury text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex-shrink-0">
                    <a href="/" class="text-2xl font-bold tracking-wider">TOKACHI YAKINIKU KARIN</a>
                    <div class="text-xs text-gray-300 mt-1">管理画面</div>
                </div>
                <div class="flex space-x-8">
                    <a href="/" class="hover:text-amber-500 transition">
                      <i class="fas fa-home"></i> サイトに戻る
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- タブナビゲーション -->
        <div class="flex space-x-4 mb-8 border-b border-gray-300">
            <button onclick="switchTab('category')" id="tab-category" class="px-6 py-3 font-bold border-b-4 border-amber-600 text-amber-600">
                <i class="fas fa-list"></i> カテゴリー管理
            </button>
            <button onclick="switchTab('menu')" id="tab-menu" class="px-6 py-3 font-bold border-b-4 border-transparent hover:text-amber-600">
                <i class="fas fa-utensils"></i> メニュー管理
            </button>
            <button onclick="switchTab('text')" id="tab-text" class="px-6 py-3 font-bold border-b-4 border-transparent hover:text-amber-600">
                <i class="fas fa-edit"></i> テキスト管理
            </button>
            <button onclick="switchTab('image')" id="tab-image" class="px-6 py-3 font-bold border-b-4 border-transparent hover:text-amber-600">
                <i class="fas fa-image"></i> 画像管理
            </button>
        </div>

        <!-- カテゴリー管理セクション -->
        <div id="section-category" class="tab-section">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">カテゴリー一覧</h2>
                </div>
                
                <div id="category-list" class="space-y-4">
                    <!-- JavaScript で動的に読み込まれます -->
                </div>
            </div>
        </div>

        <!-- メニュー管理セクション -->
        <div id="section-menu" class="tab-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">メニュー一覧</h2>
                    <button onclick="openMenuModal()" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg transition">
                        <i class="fas fa-plus"></i> 新規追加
                    </button>
                </div>
                
                <div id="menu-list" class="space-y-4">
                    <!-- JavaScript で動的に読み込まれます -->
                </div>
            </div>
        </div>

        <!-- テキスト管理セクション -->
        <div id="section-text" class="tab-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ページテキスト一覧</h2>
                </div>
                
                <div id="text-list" class="space-y-4">
                    <!-- JavaScript で動的に読み込まれます -->
                </div>
            </div>
        </div>

        <!-- 画像管理セクション -->
        <div id="section-image" class="tab-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ページ画像一覧</h2>
                </div>
                
                <div id="image-list" class="space-y-4">
                    <!-- JavaScript で動的に読み込まれます -->
                </div>
            </div>
        </div>

    </div>

    <!-- カテゴリー編集モーダル -->
    <div id="category-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">カテゴリー編集</h3>
                    <button onclick="closeCategoryModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="category-form" class="space-y-4">
                    <input type="hidden" id="category-id">
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">カテゴリー名</label>
                        <input type="text" id="category-name" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">カテゴリー画像</label>
                        
                        <!-- 現在の画像プレビュー -->
                        <div id="category-image-preview" class="mb-3">
                          <img id="category-preview-img" src="" alt="画像プレビュー" class="max-w-full h-48 object-cover rounded-lg border-2 border-gray-300" style="display: none;">
                        </div>
                        
                        <!-- 画像ファイル選択 -->
                        <div class="flex items-center space-x-4 mb-2">
                          <label class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition">
                            <i class="fas fa-upload mr-2"></i>
                            画像を選択
                            <input type="file" id="category-image-file" accept="image/*" class="hidden" onchange="handleCategoryImageUpload(event)">
                          </label>
                          <button type="button" onclick="clearCategoryImage()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-times mr-2"></i>画像をクリア
                          </button>
                        </div>
                        
                        <!-- 画像URL入力（オプション） -->
                        <input type="url" id="category-image-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent" placeholder="または画像URL: https://example.com/image.jpg">
                        <p class="text-xs text-gray-500 mt-1">メニューページのヘッダー画像として表示されます</p>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeCategoryModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                            キャンセル
                        </button>
                        <button type="submit" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- メニュー編集モーダル -->
    <div id="menu-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold" id="menu-modal-title">メニュー追加</h3>
                    <button onclick="closeMenuModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="menu-form" class="space-y-4">
                    <input type="hidden" id="menu-id">
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">カテゴリー</label>
                        <select id="menu-category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">商品名</label>
                        <input type="text" id="menu-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">説明</label>
                        <textarea id="menu-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">価格（円）</label>
                        <input type="number" id="menu-price" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">メニュー画像</label>
                        
                        <!-- 現在の画像プレビュー -->
                        <div id="menu-image-preview" class="mb-3">
                          <img id="menu-preview-img" src="" alt="画像プレビュー" class="max-w-full h-48 object-cover rounded-lg border-2 border-gray-300" style="display: none;">
                        </div>
                        
                        <!-- 画像ファイル選択 -->
                        <div class="flex items-center space-x-4 mb-2">
                          <label class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition">
                            <i class="fas fa-upload mr-2"></i>
                            画像を選択
                            <input type="file" id="menu-image-file" accept="image/*" class="hidden" onchange="handleMenuImageUpload(event)">
                          </label>
                          <button type="button" onclick="clearMenuImage()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-times mr-2"></i>画像をクリア
                          </button>
                        </div>
                        
                        <!-- 画像URL入力（オプション） -->
                        <input type="url" id="menu-image-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent" placeholder="または画像URL: https://example.com/image.jpg">
                        <p class="text-xs text-gray-500 mt-1">Unsplash、Pixabay などの画像URLを入力</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">表示順</label>
                        <input type="number" id="menu-display-order" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent">
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="menu-visible" checked class="w-5 h-5 text-amber-600">
                        <label class="ml-2 font-bold">表示する</label>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeMenuModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                            キャンセル
                        </button>
                        <button type="submit" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- テキスト編集モーダル -->
    <div id="text-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">テキスト編集</h3>
                    <button onclick="closeTextModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="text-form" class="space-y-4">
                    <input type="hidden" id="text-key">
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">キー</label>
                        <input type="text" id="text-key-display" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">ページ / セクション</label>
                        <input type="text" id="text-location" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">説明</label>
                        <input type="text" id="text-description" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">テキスト内容</label>
                        <textarea id="text-value" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent"></textarea>
                        <p class="text-xs text-gray-500 mt-1">改行は自動的に反映されます。HTMLタグも使用可能です（&lt;b&gt;、&lt;i&gt;など）</p>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeTextModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                            キャンセル
                        </button>
                        <button type="submit" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 画像編集モーダル -->
    <div id="image-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">画像編集</h3>
                    <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="image-form" class="space-y-4">
                    <input type="hidden" id="image-key">
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">キー</label>
                        <input type="text" id="image-key-display" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">ページ / セクション</label>
                        <input type="text" id="image-location" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">説明</label>
                        <input type="text" id="image-description" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">現在の画像</label>
                        <div class="mb-3">
                            <img id="image-preview-current" src="" alt="現在の画像" class="max-w-full h-48 object-cover rounded-lg border-2 border-gray-300">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">新しい画像</label>
                        
                        <!-- 画像ファイル選択 -->
                        <div class="flex items-center space-x-4 mb-2">
                            <label class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition">
                                <i class="fas fa-upload mr-2"></i>
                                画像を選択
                                <input type="file" id="page-image-file" accept="image/*" class="hidden" onchange="handlePageImageUpload(event)">
                            </label>
                            <button type="button" onclick="clearPageImage()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                <i class="fas fa-times mr-2"></i>クリア
                            </button>
                        </div>
                        
                        <!-- 新しい画像プレビュー -->
                        <div id="new-image-preview" class="mb-3" style="display: none;">
                            <img id="image-preview-new" src="" alt="新しい画像" class="max-w-full h-48 object-cover rounded-lg border-2 border-green-500">
                        </div>
                        
                        <!-- 画像URL入力（オプション） -->
                        <input type="url" id="page-image-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent" placeholder="または画像URL: https://example.com/image.jpg">
                        <p class="text-xs text-gray-500 mt-1">画像ファイルをアップロードするか、URLを入力してください</p>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeImageModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                            キャンセル
                        </button>
                        <button type="submit" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
      let categories = []
      let currentEditingMenuId = null
      let currentEditingCategoryId = null
      let currentCategoryImageData = null
      let currentMenuImageData = null
      let pageTexts = []
      let currentEditingTextKey = null
      let pageImages = []
      let currentEditingImageKey = null
      let currentPageImageData = null
      
      // タブ切り替え
      function switchTab(tab) {
        document.querySelectorAll('.tab-section').forEach(el => el.classList.add('hidden'))
        document.querySelectorAll('[id^="tab-"]').forEach(el => {
          el.classList.remove('border-amber-600', 'text-amber-600')
          el.classList.add('border-transparent')
        })
        
        document.getElementById(`section-${tab}`).classList.remove('hidden')
        document.getElementById(`tab-${tab}`).classList.add('border-amber-600', 'text-amber-600')
      }
      
      // カテゴリー一覧の読み込み
      async function loadCategoryList() {
        try {
          const response = await axios.get('/api/menu-categories')
          categories = response.data
          
          document.getElementById('category-list').innerHTML = categories.map(category => `
            <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
              <div class="flex items-center space-x-4 flex-1">
                <div class="w-32 h-24 bg-gray-200 rounded overflow-hidden">
                  <img src="${category.image_url || 'https://images.unsplash.com/photo-1558030006-450675393462?w=400'}" 
                       alt="${category.name}" 
                       class="w-full h-full object-cover">
                </div>
                <div class="flex-1">
                  <div class="font-bold text-lg">${category.name}</div>
                  <div class="text-sm text-gray-500">表示順: ${category.display_order}</div>
                  ${category.image_url ? '<div class="text-xs text-green-600 mt-1">✓ 画像設定済み</div>' : '<div class="text-xs text-gray-400 mt-1">画像未設定</div>'}
                </div>
              </div>
              <div class="flex space-x-2">
                <button onclick="editCategory(${category.id})" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition">
                  <i class="fas fa-edit"></i> 編集
                </button>
              </div>
            </div>
          `).join('')
        } catch (error) {
          console.error('Failed to load categories:', error)
        }
      }
      
      // カテゴリー画像アップロード処理
      function handleCategoryImageUpload(event) {
        const file = event.target.files[0]
        if (!file) return
        
        // ファイルサイズチェック（5MB以下）
        if (file.size > 5 * 1024 * 1024) {
          alert('画像サイズは5MB以下にしてください')
          return
        }
        
        const reader = new FileReader()
        reader.onload = (e) => {
          currentCategoryImageData = e.target.result
          const previewImg = document.getElementById('category-preview-img')
          previewImg.src = currentCategoryImageData
          previewImg.style.display = 'block'
          
          // URL入力欄をクリア
          document.getElementById('category-image-url').value = ''
        }
        reader.readAsDataURL(file)
      }
      
      // カテゴリー画像クリア
      function clearCategoryImage() {
        currentCategoryImageData = null
        document.getElementById('category-preview-img').style.display = 'none'
        document.getElementById('category-preview-img').src = ''
        document.getElementById('category-image-file').value = ''
        document.getElementById('category-image-url').value = ''
      }
      
      // カテゴリー編集
      async function editCategory(id) {
        const category = categories.find(c => c.id === id)
        if (!category) return
        
        currentEditingCategoryId = id
        currentCategoryImageData = null
        
        document.getElementById('category-id').value = category.id
        document.getElementById('category-name').value = category.name
        document.getElementById('category-image-url').value = category.image_url || ''
        
        // 既存画像があればプレビュー表示
        if (category.image_url) {
          const previewImg = document.getElementById('category-preview-img')
          previewImg.src = category.image_url
          previewImg.style.display = 'block'
        } else {
          clearCategoryImage()
        }
        
        document.getElementById('category-modal').classList.add('active')
      }
      
      function closeCategoryModal() {
        document.getElementById('category-modal').classList.remove('active')
      }
      
      // カテゴリーフォーム送信
      document.getElementById('category-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        
        let imageUrl = document.getElementById('category-image-url').value || null
        
        // アップロードした画像がある場合、Base64データを使用
        if (currentCategoryImageData) {
          try {
            const uploadResponse = await axios.post('/api/admin/upload-image', {
              imageData: currentCategoryImageData
            })
            imageUrl = uploadResponse.data.imageUrl
          } catch (error) {
            console.error('Failed to upload image:', error)
            alert('画像のアップロードに失敗しました')
            return
          }
        }
        
        const data = { image_url: imageUrl }
        
        try {
          await axios.put(`/api/admin/menu-categories/${currentEditingCategoryId}`, data)
          alert('更新しました')
          closeCategoryModal()
          loadCategoryList()
          loadCategories()
          currentCategoryImageData = null
        } catch (error) {
          console.error('Failed to update category:', error)
          alert('更新に失敗しました')
        }
      })
      
      // メニューカテゴリーの読み込み
      async function loadCategories() {
        try {
          const response = await axios.get('/api/menu-categories')
          categories = response.data
          
          const select = document.getElementById('menu-category')
          select.innerHTML = '<option value="">選択してください</option>' +
            categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')
        } catch (error) {
          console.error('Failed to load categories:', error)
        }
      }
      
      // メニュー一覧の読み込み
      async function loadMenuItems() {
        try {
          const response = await axios.get('/api/admin/menu-items')
          const items = response.data
          
          const groupedByCategory = {}
          items.forEach(item => {
            if (!groupedByCategory[item.category_name]) {
              groupedByCategory[item.category_name] = []
            }
            groupedByCategory[item.category_name].push(item)
          })
          
          document.getElementById('menu-list').innerHTML = Object.keys(groupedByCategory).map(categoryName => `
            <div class="border-l-4 border-amber-600 pl-4 mb-6">
              <h3 class="text-xl font-bold mb-4">${categoryName}</h3>
              <div class="space-y-2">
                ${groupedByCategory[categoryName].map(item => `
                  <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                    <div class="flex items-center space-x-4 flex-1">
                      <img src="${item.image_url || 'https://images.unsplash.com/photo-1558030006-450675393462?w=100'}" 
                           alt="${item.name}" 
                           class="w-16 h-16 object-cover rounded">
                      <div class="flex-1">
                        <div class="font-bold">${item.name}</div>
                        <div class="text-sm text-gray-600">${item.description || ''}</div>
                        <div class="text-amber-600 font-bold">¥${(item.price || 0).toLocaleString()}</div>
                      </div>
                      <div class="text-sm text-gray-500">
                        ${item.is_visible ? '<span class="text-green-600">✓ 表示中</span>' : '<span class="text-gray-400">非表示</span>'}
                      </div>
                    </div>
                    <div class="flex space-x-2">
                      <button onclick="editMenuItem(${item.id})" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button onclick="deleteMenuItem(${item.id})" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')
        } catch (error) {
          console.error('Failed to load menu items:', error)
        }
      }
      
      // メニュー画像アップロード処理
      function handleMenuImageUpload(event) {
        const file = event.target.files[0]
        if (!file) return
        
        // ファイルサイズチェック（5MB以下）
        if (file.size > 5 * 1024 * 1024) {
          alert('画像サイズは5MB以下にしてください')
          return
        }
        
        const reader = new FileReader()
        reader.onload = (e) => {
          currentMenuImageData = e.target.result
          const previewImg = document.getElementById('menu-preview-img')
          previewImg.src = currentMenuImageData
          previewImg.style.display = 'block'
          
          // URL入力欄をクリア
          document.getElementById('menu-image-url').value = ''
        }
        reader.readAsDataURL(file)
      }
      
      // メニュー画像クリア
      function clearMenuImage() {
        currentMenuImageData = null
        document.getElementById('menu-preview-img').style.display = 'none'
        document.getElementById('menu-preview-img').src = ''
        document.getElementById('menu-image-file').value = ''
        document.getElementById('menu-image-url').value = ''
      }
      
      // メニュー編集モーダルを開く
      function openMenuModal(item = null) {
        currentEditingMenuId = item ? item.id : null
        currentMenuImageData = null
        
        document.getElementById('menu-modal-title').textContent = item ? 'メニュー編集' : 'メニュー追加'
        
        if (item) {
          document.getElementById('menu-id').value = item.id
          document.getElementById('menu-category').value = item.category_id
          document.getElementById('menu-name').value = item.name
          document.getElementById('menu-description').value = item.description || ''
          document.getElementById('menu-price').value = item.price || ''
          document.getElementById('menu-image-url').value = item.image_url || ''
          document.getElementById('menu-display-order').value = item.display_order || 0
          document.getElementById('menu-visible').checked = item.is_visible === 1
          
          // 既存画像があればプレビュー表示
          if (item.image_url) {
            const previewImg = document.getElementById('menu-preview-img')
            previewImg.src = item.image_url
            previewImg.style.display = 'block'
          } else {
            clearMenuImage()
          }
        } else {
          document.getElementById('menu-form').reset()
          clearMenuImage()
        }
        
        document.getElementById('menu-modal').classList.add('active')
      }
      
      function closeMenuModal() {
        document.getElementById('menu-modal').classList.remove('active')
      }
      
      // メニュー編集
      async function editMenuItem(id) {
        try {
          const response = await axios.get('/api/admin/menu-items')
          const item = response.data.find(i => i.id === id)
          if (item) {
            openMenuModal(item)
          }
        } catch (error) {
          console.error('Failed to load menu item:', error)
        }
      }
      
      // メニュー削除
      async function deleteMenuItem(id) {
        if (!confirm('本当に削除しますか？')) return
        
        try {
          await axios.delete(`/api/admin/menu-items/${id}`)
          alert('削除しました')
          loadMenuItems()
        } catch (error) {
          console.error('Failed to delete menu item:', error)
          alert('削除に失敗しました')
        }
      }
      
      // メニューフォーム送信
      document.getElementById('menu-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        
        let imageUrl = document.getElementById('menu-image-url').value || null
        
        // アップロードした画像がある場合、Base64データを使用
        if (currentMenuImageData) {
          try {
            const uploadResponse = await axios.post('/api/admin/upload-image', {
              imageData: currentMenuImageData
            })
            imageUrl = uploadResponse.data.imageUrl
          } catch (error) {
            console.error('Failed to upload image:', error)
            alert('画像のアップロードに失敗しました')
            return
          }
        }
        
        const data = {
          category_id: parseInt(document.getElementById('menu-category').value),
          name: document.getElementById('menu-name').value,
          description: document.getElementById('menu-description').value,
          price: parseInt(document.getElementById('menu-price').value) || null,
          image_url: imageUrl,
          display_order: parseInt(document.getElementById('menu-display-order').value) || 0,
          is_visible: document.getElementById('menu-visible').checked ? 1 : 0
        }
        
        try {
          if (currentEditingMenuId) {
            await axios.put(`/api/admin/menu-items/${currentEditingMenuId}`, data)
            alert('更新しました')
          } else {
            await axios.post('/api/admin/menu-items', data)
            alert('追加しました')
          }
          
          closeMenuModal()
          loadMenuItems()
          currentMenuImageData = null
        } catch (error) {
          console.error('Failed to save menu item:', error)
          alert('保存に失敗しました')
        }
      })
      
      // テキスト一覧の読み込み
      async function loadPageTexts() {
        try {
          const response = await axios.get('/api/page-texts')
          pageTexts = response.data
          
          const groupedByPage = {}
          pageTexts.forEach(text => {
            if (!groupedByPage[text.page_name]) {
              groupedByPage[text.page_name] = []
            }
            groupedByPage[text.page_name].push(text)
          })
          
          document.getElementById('text-list').innerHTML = Object.keys(groupedByPage).map(pageName => `
            <div class="border-l-4 border-amber-600 pl-4 mb-6">
              <h3 class="text-xl font-bold mb-4">${pageName}</h3>
              <div class="space-y-2">
                ${groupedByPage[pageName].map(text => {
                  const preview = text.text_value.substring(0, 100).replace(/\n/g, '<br>')
                  const hasMore = text.text_value.length > 100 ? '...' : ''
                  return `
                  <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                    <div class="flex-1">
                      <div class="font-bold">${text.text_key}</div>
                      <div class="text-sm text-gray-600">${text.description || ''}</div>
                      <div class="text-xs text-gray-500 mt-1">セクション: ${text.section_name || '-'}</div>
                      <div class="text-sm text-gray-700 mt-2 p-2 bg-white rounded border">${preview}${hasMore}</div>
                    </div>
                    <div class="flex space-x-2 ml-4">
                      <button onclick="editPageText('${text.text_key}')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                  </div>
                  `
                }).join('')}
              </div>
            </div>
          `).join('')
        } catch (error) {
          console.error('Failed to load page texts:', error)
        }
      }
      
      // テキスト編集
      function editPageText(key) {
        const text = pageTexts.find(t => t.text_key === key)
        if (!text) return
        
        currentEditingTextKey = key
        document.getElementById('text-key').value = text.text_key
        document.getElementById('text-key-display').value = text.text_key
        document.getElementById('text-location').value = `${text.page_name} / ${text.section_name || '-'}`
        document.getElementById('text-description').value = text.description || ''
        document.getElementById('text-value').value = text.text_value
        
        document.getElementById('text-modal').classList.add('active')
      }
      
      function closeTextModal() {
        document.getElementById('text-modal').classList.remove('active')
      }
      
      // テキストフォーム送信
      document.getElementById('text-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        
        const data = {
          text_value: document.getElementById('text-value').value
        }
        
        try {
          await axios.put(`/api/admin/page-texts/${currentEditingTextKey}`, data)
          alert('更新しました')
          closeTextModal()
          loadPageTexts()
        } catch (error) {
          console.error('Failed to update text:', error)
          alert('更新に失敗しました')
        }
      })
      
      // 画像一覧の読み込み
      async function loadPageImages() {
        try {
          const response = await axios.get('/api/page-images')
          pageImages = response.data
          
          const groupedByPage = {}
          pageImages.forEach(image => {
            if (!groupedByPage[image.page_name]) {
              groupedByPage[image.page_name] = []
            }
            groupedByPage[image.page_name].push(image)
          })
          
          document.getElementById('image-list').innerHTML = Object.keys(groupedByPage).map(pageName => `
            <div class="border-l-4 border-amber-600 pl-4 mb-6">
              <h3 class="text-xl font-bold mb-4">${pageName}</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${groupedByPage[pageName].map(image => `
                  <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <div class="h-48 bg-gray-200 overflow-hidden">
                      <img src="${image.image_url}" alt="${image.description}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4">
                      <div class="font-bold text-sm mb-1">${image.image_key}</div>
                      <div class="text-xs text-gray-600 mb-2">${image.description || ''}</div>
                      <div class="text-xs text-gray-500 mb-3">セクション: ${image.section_name || '-'}</div>
                      <button onclick="editPageImage('${image.image_key}')" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition text-sm">
                        <i class="fas fa-edit"></i> 編集
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')
        } catch (error) {
          console.error('Failed to load page images:', error)
        }
      }
      
      // 画像編集
      function editPageImage(key) {
        const image = pageImages.find(i => i.image_key === key)
        if (!image) return
        
        currentEditingImageKey = key
        currentPageImageData = null
        
        document.getElementById('image-key').value = image.image_key
        document.getElementById('image-key-display').value = image.image_key
        document.getElementById('image-location').value = `${image.page_name} / ${image.section_name || '-'}`
        document.getElementById('image-description').value = image.description || ''
        document.getElementById('image-preview-current').src = image.image_url
        document.getElementById('page-image-url').value = ''
        document.getElementById('new-image-preview').style.display = 'none'
        
        document.getElementById('image-modal').classList.add('active')
      }
      
      function closeImageModal() {
        document.getElementById('image-modal').classList.remove('active')
      }
      
      // ページ画像アップロード処理
      function handlePageImageUpload(event) {
        const file = event.target.files[0]
        if (!file) return
        
        if (file.size > 5 * 1024 * 1024) {
          alert('画像サイズは5MB以下にしてください')
          return
        }
        
        const reader = new FileReader()
        reader.onload = (e) => {
          currentPageImageData = e.target.result
          document.getElementById('image-preview-new').src = currentPageImageData
          document.getElementById('new-image-preview').style.display = 'block'
          document.getElementById('page-image-url').value = ''
        }
        reader.readAsDataURL(file)
      }
      
      // ページ画像クリア
      function clearPageImage() {
        currentPageImageData = null
        document.getElementById('image-preview-new').src = ''
        document.getElementById('new-image-preview').style.display = 'none'
        document.getElementById('page-image-file').value = ''
        document.getElementById('page-image-url').value = ''
      }
      
      // 画像フォーム送信
      document.getElementById('image-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        
        let imageUrl = document.getElementById('page-image-url').value
        
        // アップロードした画像がある場合
        if (currentPageImageData) {
          try {
            const uploadResponse = await axios.post('/api/admin/upload-image', {
              imageData: currentPageImageData
            })
            imageUrl = uploadResponse.data.imageUrl
          } catch (error) {
            console.error('Failed to upload image:', error)
            alert('画像のアップロードに失敗しました')
            return
          }
        }
        
        if (!imageUrl) {
          alert('画像を選択するかURLを入力してください')
          return
        }
        
        const data = { image_url: imageUrl }
        
        try {
          await axios.put(`/api/admin/page-images/${currentEditingImageKey}`, data)
          alert('更新しました')
          closeImageModal()
          loadPageImages()
          currentPageImageData = null
        } catch (error) {
          console.error('Failed to update image:', error)
          alert('更新に失敗しました')
        }
      })
      
      // 初期化
      document.addEventListener('DOMContentLoaded', () => {
        loadCategories()
        loadCategoryList()
        loadMenuItems()
        loadPageTexts()
        loadPageImages()
      })
    </script>
</body>
</html>
