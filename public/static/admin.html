<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理画面 | TOKACHI YAKINIKU KARIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600;700&family=Noto+Sans+JP:wght@300;400;500&display=swap');
      
      body {
        font-family: 'Noto Sans JP', sans-serif;
      }
      
      h1, h2, h3, h4 {
        font-family: 'Noto Serif JP', serif;
      }
      
      .bg-luxury {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      }
      
      .modal {
        display: none;
      }
      
      .modal.active {
        display: flex;
      }
    </style>
</head>
<body class="bg-gray-100">
    <!-- ナビゲーション -->
    <nav class="bg-luxury text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex-shrink-0">
                    <a href="/" class="text-2xl font-bold tracking-wider">TOKACHI YAKINIKU KARIN</a>
                    <div class="text-xs text-gray-300 mt-1">管理画面</div>
                </div>
                <div class="flex space-x-8">
                    <a href="/" class="hover:text-amber-500 transition">
                      <i class="fas fa-home"></i> サイトに戻る
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- タブナビゲーション -->
        <div class="flex space-x-4 mb-8 border-b border-gray-300 overflow-x-auto">
            <button onclick="switchTab('category')" id="tab-category" class="px-6 py-3 font-bold border-b-4 border-amber-600 text-amber-600 whitespace-nowrap">
                <i class="fas fa-list"></i> カテゴリー管理
            </button>
            <button onclick="switchTab('menu')" id="tab-menu" class="px-6 py-3 font-bold border-b-4 border-transparent hover:text-amber-600 whitespace-nowrap">
                <i class="fas fa-utensils"></i> メニュー管理
            </button>
            <button onclick="switchTab('lunch')" id="tab-lunch" class="px-6 py-3 font-bold border-b-4 border-transparent hover:text-amber-600 whitespace-nowrap">
                <i class="fas fa-sun"></i> ランチ管理
            </button>
            <button onclick="switchTab('news')" id="tab-news" class="px-6 py-3 font-bold border-b-4 border-transparent hover:text-amber-600 whitespace-nowrap">
                <i class="fas fa-newspaper"></i> ニュース管理
            </button>
            <button onclick="switchTab('instagram')" id="tab-instagram" class="px-6 py-3 font-bold border-b-4 border-transparent hover:text-amber-600 whitespace-nowrap">
                <i class="fab fa-instagram"></i> Instagram連携
            </button>
            <button onclick="switchTab('text')" id="tab-text" class="px-6 py-3 font-bold border-b-4 border-transparent hover:text-amber-600 whitespace-nowrap">
                <i class="fas fa-edit"></i> テキスト管理
            </button>
            <button onclick="switchTab('image')" id="tab-image" class="px-6 py-3 font-bold border-b-4 border-transparent hover:text-amber-600 whitespace-nowrap">
                <i class="fas fa-image"></i> 画像管理
            </button>
        </div>

        <!-- カテゴリー管理セクション -->
        <div id="section-category" class="tab-section">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">カテゴリー一覧</h2>
                </div>
                
                <div id="category-list" class="space-y-4">
                    <!-- JavaScript で動的に読み込まれます -->
                </div>
            </div>
        </div>

        <!-- メニュー管理セクション -->
        <div id="section-menu" class="tab-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">メニュー一覧</h2>
                    <button onclick="openMenuModal()" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg transition">
                        <i class="fas fa-plus"></i> 新規追加
                    </button>
                </div>
                
                <div id="menu-list" class="space-y-4">
                    <!-- JavaScript で動的に読み込まれます -->
                </div>
            </div>
        </div>

        <!-- ランチメニュー管理セクション -->
        <div id="section-lunch" class="tab-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ランチメニュー一覧</h2>
                    <button onclick="openLunchModal()" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg transition">
                        <i class="fas fa-plus"></i> 新規追加
                    </button>
                </div>
                
                <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-sm text-blue-900">
                        <i class="fas fa-info-circle mr-2"></i>
                        ランチメニューの表示順序はドラッグ&ドロップまたは「表示順」を変更して保存してください
                    </p>
                </div>
                
                <div id="lunch-list" class="space-y-4">
                    <!-- JavaScript で動的に読み込まれます -->
                </div>
            </div>
        </div>

        <!-- ニュース管理セクション -->
        <div id="section-news" class="tab-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ニュース一覧</h2>
                    <button onclick="openNewsModal()" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg transition">
                        <i class="fas fa-plus"></i> 新規追加
                    </button>
                </div>
                
                <div id="news-list" class="space-y-4">
                    <!-- JavaScript で動的に読み込まれます -->
                </div>
            </div>
        </div>

        <!-- Instagram連携セクション -->
        <div id="section-instagram" class="tab-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6">Instagram連携</h2>
                
                <!-- ステータス表示 -->
                <div id="instagram-status" class="mb-8 p-6 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-bold mb-4">連携ステータス</h3>
                    <div id="instagram-status-content">
                        <p class="text-gray-500">読み込み中...</p>
                    </div>
                </div>
                
                <!-- 同期ボタン -->
                <div class="mb-8">
                    <button onclick="syncInstagram()" id="sync-instagram-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-8 rounded-lg transition shadow-lg">
                        <i class="fab fa-instagram mr-2"></i> Instagramから投稿を同期
                    </button>
                    <p class="text-sm text-gray-500 mt-2">最新25件のInstagram投稿をニュースページに同期します</p>
                </div>
                
                <!-- 最近の同期結果 -->
                <div id="sync-results" class="hidden mb-8 p-6 rounded-lg">
                    <!-- 同期結果がここに表示されます -->
                </div>
                
                <!-- 設定方法 -->
                <div class="p-6 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-lg font-bold mb-4 text-blue-900">
                        <i class="fas fa-info-circle"></i> Instagram連携の設定方法
                    </h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm text-blue-900">
                        <li>Meta for Developersでアプリを作成</li>
                        <li>Instagram Basic Display APIを有効化</li>
                        <li>アクセストークン（長期）を取得</li>
                        <li>Cloudflare Pagesにトークンを設定:
                            <pre class="mt-2 p-2 bg-blue-100 rounded text-xs overflow-x-auto">npx wrangler pages secret put INSTAGRAM_ACCESS_TOKEN --project-name webapp</pre>
                        </li>
                        <li>6時間ごとに自動同期されます（Cron Triggers）</li>
                    </ol>
                    <div class="mt-4">
                        <a href="https://developers.facebook.com/docs/instagram-basic-display-api" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm">
                            <i class="fas fa-external-link-alt"></i> Instagram Basic Display API ドキュメント
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- テキスト管理セクション -->
        <div id="section-text" class="tab-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ページテキスト一覧</h2>
                </div>
                
                <div id="text-list" class="space-y-4">
                    <!-- JavaScript で動的に読み込まれます -->
                </div>
            </div>
        </div>

        <!-- 画像管理セクション -->
        <div id="section-image" class="tab-section hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ページ画像一覧</h2>
                </div>
                
                <div id="image-list" class="space-y-4">
                    <!-- JavaScript で動的に読み込まれます -->
                </div>
            </div>
        </div>

    </div>

    <!-- カテゴリー編集モーダル -->
    <div id="category-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">カテゴリー編集</h3>
                    <button onclick="closeCategoryModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="category-form" class="space-y-4">
                    <input type="hidden" id="category-id">
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">カテゴリー名</label>
                        <input type="text" id="category-name" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">カテゴリー画像</label>
                        
                        <!-- 現在の画像プレビュー -->
                        <div id="category-image-preview" class="mb-3">
                          <img id="category-preview-img" src="" alt="画像プレビュー" class="max-w-full h-48 object-cover rounded-lg border-2 border-gray-300" style="display: none;">
                        </div>
                        
                        <!-- 画像ファイル選択 -->
                        <div class="flex items-center space-x-4 mb-2">
                          <label class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition">
                            <i class="fas fa-upload mr-2"></i>
                            画像を選択
                            <input type="file" id="category-image-file" accept="image/*" class="hidden" onchange="handleCategoryImageUpload(event)">
                          </label>
                          <button type="button" onclick="clearCategoryImage()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-times mr-2"></i>画像をクリア
                          </button>
                        </div>
                        
                        <!-- 画像URL入力（オプション） -->
                        <input type="url" id="category-image-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent" placeholder="または画像URL: https://example.com/image.jpg">
                        <p class="text-xs text-gray-500 mt-1">メニューページのヘッダー画像として表示されます</p>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeCategoryModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                            キャンセル
                        </button>
                        <button type="submit" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- メニュー編集モーダル -->
    <div id="menu-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold" id="menu-modal-title">メニュー追加</h3>
                    <button onclick="closeMenuModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="menu-form" class="space-y-4">
                    <input type="hidden" id="menu-id">
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">カテゴリー</label>
                        <select id="menu-category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">商品名</label>
                        <input type="text" id="menu-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">説明</label>
                        <textarea id="menu-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">価格（円）</label>
                        <input type="number" id="menu-price" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">メニュー画像</label>
                        
                        <!-- 現在の画像プレビュー -->
                        <div id="menu-image-preview" class="mb-3">
                          <img id="menu-preview-img" src="" alt="画像プレビュー" class="max-w-full h-48 object-cover rounded-lg border-2 border-gray-300" style="display: none;">
                        </div>
                        
                        <!-- 画像ファイル選択 -->
                        <div class="flex items-center space-x-4 mb-2">
                          <label class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition">
                            <i class="fas fa-upload mr-2"></i>
                            画像を選択
                            <input type="file" id="menu-image-file" accept="image/*" class="hidden" onchange="handleMenuImageUpload(event)">
                          </label>
                          <button type="button" onclick="clearMenuImage()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-times mr-2"></i>画像をクリア
                          </button>
                        </div>
                        
                        <!-- 画像URL入力（オプション） -->
                        <input type="url" id="menu-image-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent" placeholder="または画像URL: https://example.com/image.jpg">
                        <p class="text-xs text-gray-500 mt-1">Unsplash、Pixabay などの画像URLを入力</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">表示順</label>
                        <input type="number" id="menu-display-order" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent">
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="menu-visible" checked class="w-5 h-5 text-amber-600">
                        <label class="ml-2 font-bold">表示する</label>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeMenuModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                            キャンセル
                        </button>
                        <button type="submit" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- テキスト編集モーダル -->
    <div id="text-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">テキスト編集</h3>
                    <button onclick="closeTextModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="text-form" class="space-y-4">
                    <input type="hidden" id="text-key">
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">キー</label>
                        <input type="text" id="text-key-display" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">ページ / セクション</label>
                        <input type="text" id="text-location" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">説明</label>
                        <input type="text" id="text-description" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">テキスト内容</label>
                        <textarea id="text-value" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent"></textarea>
                        <p class="text-xs text-gray-500 mt-1">改行は自動的に反映されます。HTMLタグも使用可能です（&lt;b&gt;、&lt;i&gt;など）</p>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeTextModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                            キャンセル
                        </button>
                        <button type="submit" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 画像編集モーダル -->
    <div id="image-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">画像編集</h3>
                    <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="image-form" class="space-y-4">
                    <input type="hidden" id="image-key">
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">キー</label>
                        <input type="text" id="image-key-display" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">ページ / セクション</label>
                        <input type="text" id="image-location" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">説明</label>
                        <input type="text" id="image-description" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">現在の画像</label>
                        <div class="mb-3">
                            <img id="image-preview-current" src="" alt="現在の画像" class="max-w-full h-48 object-cover rounded-lg border-2 border-gray-300">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-2">新しい画像</label>
                        
                        <!-- 画像ファイル選択 -->
                        <div class="flex items-center space-x-4 mb-2">
                            <label class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition">
                                <i class="fas fa-upload mr-2"></i>
                                画像を選択
                                <input type="file" id="page-image-file" accept="image/*" class="hidden" onchange="handlePageImageUpload(event)">
                            </label>
                            <button type="button" onclick="clearPageImage()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                <i class="fas fa-times mr-2"></i>クリア
                            </button>
                        </div>
                        
                        <!-- 新しい画像プレビュー -->
                        <div id="new-image-preview" class="mb-3" style="display: none;">
                            <img id="image-preview-new" src="" alt="新しい画像" class="max-w-full h-48 object-cover rounded-lg border-2 border-green-500">
                        </div>
                        
                        <!-- 画像URL入力（オプション） -->
                        <div class="mt-3">
                            <label class="block text-xs text-gray-600 mb-1">または画像URL:</label>
                            <input type="url" id="page-image-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-600 focus:border-transparent" placeholder="https://example.com/image.jpg">
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2">画像ファイルをアップロードするか、URLを入力してください</p>
                        <p class="text-xs text-amber-600 mt-1">⚠️ ファイルサイズは500KB以下を推奨（大きすぎると保存に失敗します）</p>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" onclick="closeImageModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                            キャンセル
                        </button>
                        <button type="submit" class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
      let categories = []
      let currentEditingMenuId = null
      let currentEditingCategoryId = null
      let currentCategoryImageData = null
      let currentMenuImageData = null
      let pageTexts = []
      let currentEditingTextKey = null
      let pageImages = []
      let currentEditingImageKey = null
      let currentPageImageData = null
      
      // タブ切り替え
      window.switchTab = function(tab) {
        document.querySelectorAll('.tab-section').forEach(el => el.classList.add('hidden'))
        document.querySelectorAll('[id^="tab-"]').forEach(el => {
          el.classList.remove('border-amber-600', 'text-amber-600')
          el.classList.add('border-transparent')
        })
        
        document.getElementById(`section-${tab}`).classList.remove('hidden')
        document.getElementById(`tab-${tab}`).classList.add('border-amber-600', 'text-amber-600')
      }
      
      // カテゴリー一覧の読み込み
      async function loadCategoryList() {
        const listEl = document.getElementById('category-list')
        if (!listEl) {
          console.error('category-list element not found!')
          return
        }
        
        try {
          console.log('Loading category list...')
          listEl.innerHTML = '<p class="text-gray-500 text-center py-8">読み込み中...</p>'
          
          const response = await axios.get('/api/menu-categories')
          categories = response.data
          console.log('Categories loaded:', categories.length)
          
          if (categories.length === 0) {
            listEl.innerHTML = '<p class="text-gray-500 text-center py-8">カテゴリーがありません</p>'
            return
          }
          
          listEl.innerHTML = categories.map(category => `
            <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
              <div class="flex items-center space-x-4 flex-1">
                <div class="w-32 h-24 bg-gray-200 rounded overflow-hidden">
                  <img src="${category.image_url || 'https://images.unsplash.com/photo-1558030006-450675393462?w=400'}" 
                       alt="${category.name}" 
                       class="w-full h-full object-cover">
                </div>
                <div class="flex-1">
                  <div class="font-bold text-lg">${category.name}</div>
                  <div class="text-sm text-gray-500">表示順: ${category.display_order}</div>
                  ${category.image_url ? '<div class="text-xs text-green-600 mt-1">✓ 画像設定済み</div>' : '<div class="text-xs text-gray-400 mt-1">画像未設定</div>'}
                </div>
              </div>
              <div class="flex space-x-2">
                <button onclick="editCategory(${category.id})" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition">
                  <i class="fas fa-edit"></i> 編集
                </button>
              </div>
            </div>
          `).join('')
          console.log('Category list rendered successfully')
        } catch (error) {
          console.error('Failed to load categories:', error)
          listEl.innerHTML = '<p class="text-red-500 text-center py-8">カテゴリーの読み込みに失敗しました: ' + error.message + '</p>'
        }
      }
      
      // カテゴリー画像アップロード処理
      window.handleCategoryImageUpload = function(event) {
        const file = event.target.files[0]
        if (!file) return
        
        // ファイルサイズチェック（5MB以下）
        if (file.size > 5 * 1024 * 1024) {
          alert('画像サイズは5MB以下にしてください')
          return
        }
        
        const reader = new FileReader()
        reader.onload = (e) => {
          currentCategoryImageData = e.target.result
          const previewImg = document.getElementById('category-preview-img')
          previewImg.src = currentCategoryImageData
          previewImg.style.display = 'block'
          
          // URL入力欄をクリア
          document.getElementById('category-image-url').value = ''
        }
        reader.readAsDataURL(file)
      }
      
      // カテゴリー画像クリア
      window.clearCategoryImage = function() {
        currentCategoryImageData = null
        document.getElementById('category-preview-img').style.display = 'none'
        document.getElementById('category-preview-img').src = ''
        document.getElementById('category-image-file').value = ''
        document.getElementById('category-image-url').value = ''
      }
      
      // カテゴリー編集
      window.editCategory = async function(id) {
        const category = categories.find(c => c.id === id)
        if (!category) return
        
        currentEditingCategoryId = id
        currentCategoryImageData = null
        
        document.getElementById('category-id').value = category.id
        document.getElementById('category-name').value = category.name
        document.getElementById('category-image-url').value = category.image_url || ''
        
        // 既存画像があればプレビュー表示
        if (category.image_url) {
          const previewImg = document.getElementById('category-preview-img')
          previewImg.src = category.image_url
          previewImg.style.display = 'block'
        } else {
          clearCategoryImage()
        }
        
        document.getElementById('category-modal').classList.add('active')
      }
      
      window.closeCategoryModal = function() {
        document.getElementById('category-modal').classList.remove('active')
      }
      
      // カテゴリーフォーム送信
      document.getElementById('category-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        
        let imageUrl = document.getElementById('category-image-url').value || null
        
        // アップロードした画像がある場合、Base64データを使用
        if (currentCategoryImageData) {
          try {
            const uploadResponse = await axios.post('/api/admin/upload-image', {
              imageData: currentCategoryImageData
            })
            imageUrl = uploadResponse.data.imageUrl
          } catch (error) {
            console.error('Failed to upload image:', error)
            alert('画像のアップロードに失敗しました')
            return
          }
        }
        
        const data = { image_url: imageUrl }
        
        try {
          await axios.put(`/api/admin/menu-categories/${currentEditingCategoryId}`, data)
          alert('更新しました')
          closeCategoryModal()
          loadCategoryList()
          loadCategories()
          currentCategoryImageData = null
        } catch (error) {
          console.error('Failed to update category:', error)
          alert('更新に失敗しました')
        }
      })
      
      // メニューカテゴリーの読み込み
      async function loadCategories() {
        try {
          const response = await axios.get('/api/menu-categories')
          categories = response.data
          
          const select = document.getElementById('menu-category')
          select.innerHTML = '<option value="">選択してください</option>' +
            categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')
        } catch (error) {
          console.error('Failed to load categories:', error)
        }
      }
      
      // メニュー一覧の読み込み
      async function loadMenuItems() {
        const listEl = document.getElementById('menu-list')
        if (!listEl) {
          console.error('menu-list element not found!')
          return
        }
        
        try {
          listEl.innerHTML = '<p class="text-gray-500 text-center py-8">読み込み中...</p>'
          
          const response = await axios.get('/api/admin/menu-items')
          const items = response.data
          console.log('Menu items loaded:', items.length)
          
          if (items.length === 0) {
            listEl.innerHTML = '<p class="text-gray-500 text-center py-8">メニューアイテムがありません</p>'
            return
          }
          
          const groupedByCategory = {}
          items.forEach(item => {
            if (!groupedByCategory[item.category_name]) {
              groupedByCategory[item.category_name] = []
            }
            groupedByCategory[item.category_name].push(item)
          })
          
          listEl.innerHTML = Object.keys(groupedByCategory).map(categoryName => `
            <div class="border-l-4 border-amber-600 pl-4 mb-6">
              <h3 class="text-xl font-bold mb-4">${categoryName}</h3>
              <div class="space-y-2">
                ${groupedByCategory[categoryName].map(item => `
                  <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                    <div class="flex items-center space-x-4 flex-1">
                      <img src="${item.image_url || 'https://images.unsplash.com/photo-1558030006-450675393462?w=100'}" 
                           alt="${item.name}" 
                           class="w-16 h-16 object-cover rounded">
                      <div class="flex-1">
                        <div class="font-bold">${item.name}</div>
                        <div class="text-sm text-gray-600">${item.description || ''}</div>
                        <div class="text-amber-600 font-bold">¥${(item.price || 0).toLocaleString()}</div>
                      </div>
                      <div class="text-sm text-gray-500">
                        ${item.is_visible ? '<span class="text-green-600">✓ 表示中</span>' : '<span class="text-gray-400">非表示</span>'}
                      </div>
                    </div>
                    <div class="flex space-x-2">
                      <button onclick="editMenuItem(${item.id})" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button onclick="deleteMenuItem(${item.id})" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')
          console.log('Menu items rendered successfully')
        } catch (error) {
          console.error('Failed to load menu items:', error)
          listEl.innerHTML = '<p class="text-red-500 text-center py-8">メニューアイテムの読み込みに失敗しました: ' + error.message + '</p>'
        }
      }
      
      // メニュー画像アップロード処理
      window.handleMenuImageUpload = function(event) {
        const file = event.target.files[0]
        if (!file) return
        
        // ファイルサイズチェック（5MB以下）
        if (file.size > 5 * 1024 * 1024) {
          alert('画像サイズは5MB以下にしてください')
          return
        }
        
        const reader = new FileReader()
        reader.onload = (e) => {
          currentMenuImageData = e.target.result
          const previewImg = document.getElementById('menu-preview-img')
          previewImg.src = currentMenuImageData
          previewImg.style.display = 'block'
          
          // URL入力欄をクリア
          document.getElementById('menu-image-url').value = ''
        }
        reader.readAsDataURL(file)
      }
      
      // メニュー画像クリア
      window.clearMenuImage = function() {
        currentMenuImageData = null
        document.getElementById('menu-preview-img').style.display = 'none'
        document.getElementById('menu-preview-img').src = ''
        document.getElementById('menu-image-file').value = ''
        document.getElementById('menu-image-url').value = ''
      }
      
      // メニュー編集モーダルを開く
      window.openMenuModal = function(item = null) {
        currentEditingMenuId = item ? item.id : null
        currentMenuImageData = null
        
        document.getElementById('menu-modal-title').textContent = item ? 'メニュー編集' : 'メニュー追加'
        
        if (item) {
          document.getElementById('menu-id').value = item.id
          document.getElementById('menu-category').value = item.category_id
          document.getElementById('menu-name').value = item.name
          document.getElementById('menu-description').value = item.description || ''
          document.getElementById('menu-price').value = item.price || ''
          document.getElementById('menu-image-url').value = item.image_url || ''
          document.getElementById('menu-display-order').value = item.display_order || 0
          document.getElementById('menu-visible').checked = item.is_visible === 1
          
          // 既存画像があればプレビュー表示
          if (item.image_url) {
            const previewImg = document.getElementById('menu-preview-img')
            previewImg.src = item.image_url
            previewImg.style.display = 'block'
          } else {
            clearMenuImage()
          }
        } else {
          document.getElementById('menu-form').reset()
          clearMenuImage()
        }
        
        document.getElementById('menu-modal').classList.add('active')
      }
      
      window.closeMenuModal = function() {
        document.getElementById('menu-modal').classList.remove('active')
      }
      
      // メニュー編集
      window.editMenuItem = async function(id) {
        try {
          const response = await axios.get('/api/admin/menu-items')
          const item = response.data.find(i => i.id === id)
          if (item) {
            openMenuModal(item)
          }
        } catch (error) {
          console.error('Failed to load menu item:', error)
        }
      }
      
      // メニュー削除
      async function deleteMenuItem(id) {
        if (!confirm('本当に削除しますか？')) return
        
        try {
          await axios.delete(`/api/admin/menu-items/${id}`)
          alert('削除しました')
          loadMenuItems()
        } catch (error) {
          console.error('Failed to delete menu item:', error)
          alert('削除に失敗しました')
        }
      }
      
      // メニューフォーム送信
      document.getElementById('menu-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        
        let imageUrl = document.getElementById('menu-image-url').value || null
        
        // アップロードした画像がある場合、Base64データを使用
        if (currentMenuImageData) {
          try {
            const uploadResponse = await axios.post('/api/admin/upload-image', {
              imageData: currentMenuImageData
            })
            imageUrl = uploadResponse.data.imageUrl
          } catch (error) {
            console.error('Failed to upload image:', error)
            alert('画像のアップロードに失敗しました')
            return
          }
        }
        
        const data = {
          category_id: parseInt(document.getElementById('menu-category').value),
          name: document.getElementById('menu-name').value,
          description: document.getElementById('menu-description').value,
          price: parseInt(document.getElementById('menu-price').value) || null,
          image_url: imageUrl,
          display_order: parseInt(document.getElementById('menu-display-order').value) || 0,
          is_visible: document.getElementById('menu-visible').checked ? 1 : 0
        }
        
        try {
          if (currentEditingMenuId) {
            await axios.put(`/api/admin/menu-items/${currentEditingMenuId}`, data)
            alert('更新しました')
          } else {
            await axios.post('/api/admin/menu-items', data)
            alert('追加しました')
          }
          
          closeMenuModal()
          loadMenuItems()
          currentMenuImageData = null
        } catch (error) {
          console.error('Failed to save menu item:', error)
          alert('保存に失敗しました')
        }
      })
      
      // テキスト一覧の読み込み
      async function loadPageTexts() {
        try {
          const response = await axios.get('/api/page-texts')
          pageTexts = response.data
          
          const groupedByPage = {}
          pageTexts.forEach(text => {
            if (!groupedByPage[text.page_name]) {
              groupedByPage[text.page_name] = []
            }
            groupedByPage[text.page_name].push(text)
          })
          
          document.getElementById('text-list').innerHTML = Object.keys(groupedByPage).map(pageName => `
            <div class="border-l-4 border-amber-600 pl-4 mb-6">
              <h3 class="text-xl font-bold mb-4">${pageName}</h3>
              <div class="space-y-2">
                ${groupedByPage[pageName].map(text => {
                  const preview = text.text_value.substring(0, 100).replace(/\n/g, '<br>')
                  const hasMore = text.text_value.length > 100 ? '...' : ''
                  return `
                  <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                    <div class="flex-1">
                      <div class="font-bold">${text.text_key}</div>
                      <div class="text-sm text-gray-600">${text.description || ''}</div>
                      <div class="text-xs text-gray-500 mt-1">セクション: ${text.section_name || '-'}</div>
                      <div class="text-sm text-gray-700 mt-2 p-2 bg-white rounded border">${preview}${hasMore}</div>
                    </div>
                    <div class="flex space-x-2 ml-4">
                      <button onclick="editPageText('${text.text_key}')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                  </div>
                  `
                }).join('')}
              </div>
            </div>
          `).join('')
        } catch (error) {
          console.error('Failed to load page texts:', error)
        }
      }
      
      // テキスト編集
      window.editPageText = function(key) {
        const text = pageTexts.find(t => t.text_key === key)
        if (!text) return
        
        currentEditingTextKey = key
        document.getElementById('text-key').value = text.text_key
        document.getElementById('text-key-display').value = text.text_key
        document.getElementById('text-location').value = `${text.page_name} / ${text.section_name || '-'}`
        document.getElementById('text-description').value = text.description || ''
        document.getElementById('text-value').value = text.text_value
        
        document.getElementById('text-modal').classList.add('active')
      }
      
      window.closeTextModal = function() {
        document.getElementById('text-modal').classList.remove('active')
      }
      
      // フォームイベントリスナーの設定
      function setupFormListeners() {
        // テキストフォーム送信
        document.getElementById('text-form').addEventListener('submit', async (e) => {
        e.preventDefault()
        
        const data = {
          text_value: document.getElementById('text-value').value
        }
        
        try {
          await axios.put(`/api/admin/page-texts/${currentEditingTextKey}`, data)
          alert('更新しました')
          closeTextModal()
          loadPageTexts()
        } catch (error) {
          console.error('Failed to update text:', error)
          alert('更新に失敗しました')
        }
        })
        
        // 画像フォーム送信
        document.getElementById('image-form').addEventListener('submit', async (e) => {
          e.preventDefault()
          
          if (!currentEditingImageKey) {
            alert('エラー: 編集中の画像キーが設定されていません')
            return
          }
          
          let imageUrl = document.getElementById('page-image-url').value
          
          // アップロードした画像がある場合
          if (currentPageImageData) {
            // Base64データのサイズをチェック
            const base64Size = currentPageImageData.length
            const sizeInKB = (base64Size / 1024).toFixed(0)
            
            console.log('Base64 size:', sizeInKB, 'KB')
            
            // 大きすぎる場合は警告
            if (base64Size > 700 * 1024) {
              alert('警告: 画像が大きすぎます (' + sizeInKB + 'KB)\\n\\nデータベース保存に失敗する可能性があります。\\n500KB以下の画像を使用することを推奨します。')
            }
            
            try {
              const uploadResponse = await axios.post('/api/admin/upload-image', {
                imageData: currentPageImageData
              })
              imageUrl = uploadResponse.data.imageUrl
            } catch (error) {
              console.error('Failed to upload image:', error)
              alert('画像のアップロードに失敗しました:\\n' + (error.response?.data?.error || error.message))
              return
            }
          }
          
          if (!imageUrl) {
            alert('画像を選択するかURLを入力してください')
            return
          }
          
          const data = { image_url: imageUrl }
          
          try {
            await axios.put(`/api/admin/page-images/${currentEditingImageKey}`, data)
            alert('画像を更新しました！')
            closeImageModal()
            loadPageImages()
            currentPageImageData = null
          } catch (error) {
            console.error('Failed to update image:', error)
            const errorMsg = error.response?.data?.error || error.response?.statusText || error.message
            
            // SQLiteエラーの場合は分かりやすいメッセージを表示
            if (errorMsg.includes('SQLITE_TOOBIG') || errorMsg.includes('too big')) {
              alert('エラー: 画像が大きすぎます\\n\\nデータベースに保存できませんでした。\\n\\n解決方法:\\n1. より小さい画像（500KB以下）を使用\\n2. 画像を圧縮\\n3. 外部URLを使用（Unsplash、Imgurなど）')
            } else {
              alert('更新に失敗しました:\\n' + errorMsg)
            }
          }
        })
      }
      
      // 画像一覧の読み込み
      async function loadPageImages() {
        try {
          const response = await axios.get('/api/page-images')
          pageImages = response.data
          
          const groupedByPage = {}
          pageImages.forEach(image => {
            if (!groupedByPage[image.page_name]) {
              groupedByPage[image.page_name] = []
            }
            groupedByPage[image.page_name].push(image)
          })
          
          document.getElementById('image-list').innerHTML = Object.keys(groupedByPage).map(pageName => `
            <div class="border-l-4 border-amber-600 pl-4 mb-6">
              <h3 class="text-xl font-bold mb-4">${pageName}</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${groupedByPage[pageName].map(image => `
                  <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <div class="h-48 bg-gray-200 overflow-hidden">
                      <img src="${image.image_url}" alt="${image.description}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4">
                      <div class="font-bold text-sm mb-1">${image.image_key}</div>
                      <div class="text-xs text-gray-600 mb-2">${image.description || ''}</div>
                      <div class="text-xs text-gray-500 mb-3">セクション: ${image.section_name || '-'}</div>
                      <button onclick="editPageImage('${image.image_key}')" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition text-sm">
                        <i class="fas fa-edit"></i> 編集
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')
        } catch (error) {
          console.error('Failed to load page images:', error)
        }
      }
      
      // 画像編集
      window.editPageImage = function(key) {
        const image = pageImages.find(i => i.image_key === key)
        
        if (!image) {
          alert('エラー: 画像が見つかりません')
          return
        }
        
        currentEditingImageKey = key
        currentPageImageData = null
        
        document.getElementById('image-key').value = image.image_key
        document.getElementById('image-key-display').value = image.image_key
        document.getElementById('image-location').value = `${image.page_name} / ${image.section_name || '-'}`
        document.getElementById('image-description').value = image.description || ''
        document.getElementById('image-preview-current').src = image.image_url
        document.getElementById('page-image-url').value = ''
        
        document.getElementById('image-modal').classList.add('active')
      }
      
      window.closeImageModal = function() {
        document.getElementById('image-modal').classList.remove('active')
      }
      
      // ページ画像アップロード処理
      window.handlePageImageUpload = function(event) {
        const file = event.target.files[0]
        if (!file) return
        
        // ファイルサイズチェック（500KB制限）
        if (file.size > 500 * 1024) {
          alert('画像サイズは500KB以下にしてください\\n\\n現在のサイズ: ' + (file.size / 1024).toFixed(0) + 'KB\\n\\n大きすぎる画像はデータベースに保存できません。\\n画像を圧縮するか、外部URLを使用してください。')
          event.target.value = ''
          return
        }
        
        const reader = new FileReader()
        reader.onload = (e) => {
          currentPageImageData = e.target.result
          document.getElementById('image-preview-new').src = currentPageImageData
          document.getElementById('new-image-preview').style.display = 'block'
          document.getElementById('page-image-url').value = ''
        }
        reader.readAsDataURL(file)
      }
      
      // ページ画像クリア
      window.clearPageImage = function() {
        currentPageImageData = null
        document.getElementById('image-preview-new').src = ''
        document.getElementById('new-image-preview').style.display = 'none'
        const fileInput = document.getElementById('page-image-file')
        if (fileInput) fileInput.value = ''
      }
      
      // ========== Instagram連携機能 ==========
      
      // Instagram連携ステータスを読み込み
      async function loadInstagramStatus() {
        try {
          const response = await axios.get('/api/admin/instagram-status')
          const data = response.data
          
          const statusContent = document.getElementById('instagram-status-content')
          
          if (data.configured) {
            statusContent.innerHTML = `
              <div class="flex items-center space-x-2 mb-4">
                <i class="fas fa-check-circle text-green-600 text-xl"></i>
                <span class="text-green-700 font-bold">Instagram APIが設定されています</span>
              </div>
              <p class="text-sm text-gray-600 mb-4">6時間ごとに自動的にInstagram投稿が同期されます</p>
              ${data.lastSyncedPosts.length > 0 ? `
                <div class="mt-4">
                  <h4 class="font-bold text-sm mb-2">最近同期された投稿（${data.lastSyncedPosts.length}件）</h4>
                  <div class="space-y-2">
                    ${data.lastSyncedPosts.map(post => `
                      <div class="text-xs p-2 bg-white rounded border">
                        <div class="font-bold">${post.title.substring(0, 60)}...</div>
                        <div class="text-gray-500">${post.published_date}</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            `
          } else {
            statusContent.innerHTML = `
              <div class="flex items-center space-x-2 mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                <span class="text-yellow-700 font-bold">Instagram APIが未設定です</span>
              </div>
              <p class="text-sm text-gray-600">下記の設定方法を参照してアクセストークンを設定してください</p>
            `
            
            // 同期ボタンを無効化
            const syncBtn = document.getElementById('sync-instagram-btn')
            if (syncBtn) {
              syncBtn.disabled = true
              syncBtn.classList.add('opacity-50', 'cursor-not-allowed')
            }
          }
        } catch (error) {
          console.error('Instagram status error:', error)
          document.getElementById('instagram-status-content').innerHTML = `
            <div class="text-red-600">
              <i class="fas fa-times-circle"></i> ステータスの取得に失敗しました
            </div>
          `
        }
      }
      
      // Instagram投稿を同期
      window.syncInstagram = async function() {
        const btn = document.getElementById('sync-instagram-btn')
        const resultsDiv = document.getElementById('sync-results')
        
        // ボタンを無効化
        btn.disabled = true
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 同期中...'
        
        try {
          const response = await axios.post('/api/admin/sync-instagram')
          const data = response.data
          
          if (data.success) {
            // 成功結果を表示
            resultsDiv.classList.remove('hidden', 'bg-red-50', 'border-red-200')
            resultsDiv.classList.add('bg-green-50', 'border', 'border-green-200')
            resultsDiv.innerHTML = `
              <div class="flex items-start space-x-3">
                <i class="fas fa-check-circle text-green-600 text-2xl mt-1"></i>
                <div class="flex-1">
                  <h3 class="font-bold text-green-900 mb-2">同期完了</h3>
                  <p class="text-sm text-green-800 mb-3">${data.message}</p>
                  <div class="grid grid-cols-3 gap-4 text-sm">
                    <div class="bg-white p-3 rounded">
                      <div class="text-gray-500">新規同期</div>
                      <div class="text-2xl font-bold text-green-600">${data.syncedCount}件</div>
                    </div>
                    <div class="bg-white p-3 rounded">
                      <div class="text-gray-500">スキップ</div>
                      <div class="text-2xl font-bold text-gray-600">${data.skippedCount}件</div>
                    </div>
                    <div class="bg-white p-3 rounded">
                      <div class="text-gray-500">合計</div>
                      <div class="text-2xl font-bold text-blue-600">${data.totalPosts}件</div>
                    </div>
                  </div>
                  ${data.syncedPosts && data.syncedPosts.length > 0 ? `
                    <div class="mt-4">
                      <h4 class="font-bold text-sm mb-2">同期された投稿</h4>
                      <div class="space-y-2 max-h-60 overflow-y-auto">
                        ${data.syncedPosts.map(post => `
                          <div class="bg-white p-2 rounded text-xs border">
                            <div class="font-bold">${post.title.substring(0, 80)}...</div>
                            <div class="text-gray-500">${post.published_date}</div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                  <div class="mt-4">
                    <a href="/news" target="_blank" class="text-green-700 hover:text-green-900 underline text-sm">
                      <i class="fas fa-external-link-alt"></i> ニュースページで確認
                    </a>
                  </div>
                </div>
              </div>
            `
            
            // ステータスを再読み込み
            loadInstagramStatus()
          } else {
            throw new Error(data.error || '同期に失敗しました')
          }
        } catch (error) {
          console.error('Sync error:', error)
          
          // エラー結果を表示
          resultsDiv.classList.remove('hidden', 'bg-green-50', 'border-green-200')
          resultsDiv.classList.add('bg-red-50', 'border', 'border-red-200')
          resultsDiv.innerHTML = `
            <div class="flex items-start space-x-3">
              <i class="fas fa-times-circle text-red-600 text-2xl mt-1"></i>
              <div class="flex-1">
                <h3 class="font-bold text-red-900 mb-2">同期失敗</h3>
                <p class="text-sm text-red-800">${error.response?.data?.error || error.message}</p>
                ${error.response?.data?.details ? `
                  <p class="text-xs text-red-600 mt-2">詳細: ${error.response.data.details}</p>
                ` : ''}
                <p class="text-xs text-gray-600 mt-3">
                  アクセストークンが正しく設定されているか確認してください
                </p>
              </div>
            </div>
          `
        } finally {
          // ボタンを再有効化
          btn.disabled = false
          btn.innerHTML = '<i class="fab fa-instagram mr-2"></i> Instagramから投稿を同期'
        }
      }
      
      // ニュース一覧を読み込み
      async function loadNewsList() {
        try {
          const response = await axios.get('/api/admin/news')
          const newsList = response.data
          
          document.getElementById('news-list').innerHTML = newsList.length === 0 
            ? '<p class="text-gray-500 text-center py-8">ニュースがありません</p>'
            : newsList.map(news => `
              <div class="flex items-start justify-between bg-gray-50 p-4 rounded-lg">
                <div class="flex-1">
                  <div class="flex items-center space-x-2 mb-2">
                    <span class="font-bold text-lg">${news.title}</span>
                    ${news.is_visible ? 
                      '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">公開中</span>' : 
                      '<span class="text-xs bg-gray-300 text-gray-700 px-2 py-1 rounded">非公開</span>'
                    }
                  </div>
                  <p class="text-sm text-gray-600 mb-2">${news.content.substring(0, 100)}${news.content.length > 100 ? '...' : ''}</p>
                  <div class="text-xs text-gray-500">
                    <i class="fas fa-calendar"></i> ${news.published_date}
                  </div>
                </div>
                <div class="flex space-x-2 ml-4">
                  <button onclick="editNews(${news.id})" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition">
                    <i class="fas fa-edit"></i> 編集
                  </button>
                  <button onclick="deleteNews(${news.id})" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition">
                    <i class="fas fa-trash"></i> 削除
                  </button>
                </div>
              </div>
            `).join('')
        } catch (error) {
          console.error('Load news error:', error)
          document.getElementById('news-list').innerHTML = '<p class="text-red-500 text-center py-8">ニュースの読み込みに失敗しました</p>'
        }
      }
      
      // ニュースモーダルを開く（簡易版 - 実装は省略）
      window.openNewsModal = function() {
        alert('ニュース追加機能は現在開発中です。Instagram同期機能をご利用ください。')
      }
      
      // ニュース編集（簡易版 - 実装は省略）
      window.editNews = function(id) {
        alert(`ニュース編集機能は現在開発中です（ID: ${id}）`)
      }
      
      // ニュース削除
      window.deleteNews = async function(id) {
        if (!confirm('このニュースを削除しますか？')) return
        
        try {
          await axios.delete(`/api/admin/news/${id}`)
          alert('ニュースを削除しました')
          loadNewsList()
        } catch (error) {
          console.error('Delete news error:', error)
          alert('ニュースの削除に失敗しました')
        }
      }
      
      // ========== ランチメニュー管理機能 ==========
      
      // ランチメニュー一覧を読み込み
      async function loadLunchMenu() {
        try {
          const response = await axios.get('/api/admin/lunch-menu')
          const lunchMenu = response.data
          
          document.getElementById('lunch-list').innerHTML = lunchMenu.length === 0 
            ? '<p class="text-gray-500 text-center py-8">ランチメニューがありません</p>'
            : lunchMenu.map(item => `
              <div class="flex items-start justify-between bg-gray-50 p-4 rounded-lg border-2 ${item.is_visible ? 'border-green-200' : 'border-gray-300'}">
                <div class="flex items-start space-x-4 flex-1">
                  <div class="w-32 h-24 bg-gray-200 rounded overflow-hidden flex-shrink-0">
                    <img src="${item.image_url}" alt="${item.name}" class="w-full h-full object-cover">
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-2">
                      <span class="font-bold text-lg">${item.name}</span>
                      <span class="text-sm text-gray-500">${item.name_en || ''}</span>
                      ${item.is_visible ? 
                        '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">公開中</span>' : 
                        '<span class="text-xs bg-gray-300 text-gray-700 px-2 py-1 rounded">非公開</span>'
                      }
                    </div>
                    <div class="text-xl font-bold text-amber-600 mb-2">¥${item.price.toLocaleString()}</div>
                    <p class="text-sm text-gray-600 mb-2">${item.description || ''}</p>
                    <div class="text-xs text-gray-400">
                      表示順: ${item.display_order}
                    </div>
                  </div>
                </div>
                <div class="flex space-x-2 ml-4">
                  <button onclick="editLunchItem(${item.id})" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition">
                    <i class="fas fa-edit"></i> 編集
                  </button>
                  <button onclick="deleteLunchItem(${item.id})" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition">
                    <i class="fas fa-trash"></i> 削除
                  </button>
                </div>
              </div>
            `).join('')
        } catch (error) {
          console.error('Load lunch menu error:', error)
          document.getElementById('lunch-list').innerHTML = '<p class="text-red-500 text-center py-8">ランチメニューの読み込みに失敗しました</p>'
        }
      }
      
      // ランチメニューモーダルを開く
      window.openLunchModal = function() {
        const name = prompt('メニュー名を入力してください:')
        if (!name) return
        
        const nameEn = prompt('英語名を入力してください（任意）:') || ''
        const priceStr = prompt('価格を入力してください（例: 1760）:')
        if (!priceStr) return
        
        const price = parseInt(priceStr)
        if (isNaN(price)) {
          alert('価格は数字で入力してください')
          return
        }
        
        const description = prompt('説明文を入力してください（1-2行）:') || ''
        const imageUrl = prompt('画像URLを入力してください（例: /lunch/lunch1.jpg）:')
        if (!imageUrl) return
        
        const displayOrderStr = prompt('表示順を入力してください（例: 1）:') || '0'
        const displayOrder = parseInt(displayOrderStr)
        
        // 作成実行
        createLunchItem(name, nameEn, price, description, imageUrl, displayOrder)
      }
      
      // ランチメニュー作成
      async function createLunchItem(name, nameEn, price, description, imageUrl, displayOrder) {
        try {
          await axios.post('/api/admin/lunch-menu', {
            name,
            name_en: nameEn,
            price,
            description,
            image_url: imageUrl,
            display_order: displayOrder,
            is_visible: true
          })
          alert('ランチメニューを追加しました')
          loadLunchMenu()
        } catch (error) {
          console.error('Create lunch item error:', error)
          alert('ランチメニューの追加に失敗しました')
        }
      }
      
      // ランチメニュー編集
      window.editLunchItem = async function(id) {
        try {
          const response = await axios.get('/api/admin/lunch-menu')
          const item = response.data.find(i => i.id === id)
          if (!item) return
          
          const name = prompt('メニュー名:', item.name)
          if (!name) return
          
          const nameEn = prompt('英語名:', item.name_en || '')
          const priceStr = prompt('価格:', item.price)
          if (!priceStr) return
          
          const price = parseInt(priceStr)
          if (isNaN(price)) {
            alert('価格は数字で入力してください')
            return
          }
          
          const description = prompt('説明文:', item.description || '')
          const imageUrl = prompt('画像URL:', item.image_url)
          if (!imageUrl) return
          
          const displayOrderStr = prompt('表示順:', item.display_order)
          const displayOrder = parseInt(displayOrderStr)
          
          const isVisibleStr = prompt('公開状態 (1:公開, 0:非公開):', item.is_visible ? '1' : '0')
          const isVisible = isVisibleStr === '1'
          
          await axios.put(\`/api/admin/lunch-menu/\${id}\`, {
            name,
            name_en: nameEn,
            price,
            description,
            image_url: imageUrl,
            display_order: displayOrder,
            is_visible: isVisible
          })
          
          alert('ランチメニューを更新しました')
          loadLunchMenu()
        } catch (error) {
          console.error('Edit lunch item error:', error)
          alert('ランチメニューの更新に失敗しました')
        }
      }
      
      // ランチメニュー削除
      window.deleteLunchItem = async function(id) {
        if (!confirm('このランチメニューを削除しますか？')) return
        
        try {
          await axios.delete(\`/api/admin/lunch-menu/\${id}\`)
          alert('ランチメニューを削除しました')
          loadLunchMenu()
        } catch (error) {
          console.error('Delete lunch item error:', error)
          alert('ランチメニューの削除に失敗しました')
        }
      }
      
      // 初期化
      document.addEventListener('DOMContentLoaded', () => {
        console.log('Admin page initialized')
        try {
          loadCategories()
          loadCategoryList()
          loadMenuItems()
          loadPageTexts()
          loadPageImages()
          loadInstagramStatus()
          loadNewsList()
          loadLunchMenu()
          
          // フォームイベントリスナーを登録
          setupFormListeners()
          console.log('All initialization functions called')
        } catch (error) {
          console.error('Initialization error:', error)
          alert('初期化エラー: ' + error.message)
        }
      })
    </script>
</body>
</html>
